<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Compare</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.18.0/cdn/themes/light.css" />
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    /* ------------------------------------------------------------------
      Global reset so the iframe box behaves predictably
    ------------------------------------------------------------------ */
    html, body { margin: 0; height: 100%; box-sizing: border-box; font-family: system-ui, sans-serif; }
    figure { height: 100%; margin: 0; display: flex; flex-direction: column; }
    figcaption { font-size: 16px; line-height: 1.2; padding: 8px 0;  text-align: left; display: flex; align-items: center; background: #fff; }
    figcaption svg { width: 1em; height: 1em; margin-inline: .3em; flex: none; fill: currentColor; cursor: pointer; }
    
    /*
    sl-image-comparer { width: 100%; height: 100%; }
    sl-image-comparer::part(base) { width: 100%; height: 100%; }
    sl-image-comparer::part(base) div { width: 100%; height: 100%; }
    sl-image-comparer::part(after), sl-image-comparer::part(before) { width: 100%; height: 300px }
    sl-image-comparer img { width: 100%; height: 100%; } 
    */

    .clamp { display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body>

  <figure>
    <sl-image-comparer>
      <img id="before" slot="before"/>
      <img id="after" slot="after"/>
    </sl-image-comparer>

    <figcaption>      
      <svg class="drawerToggle" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 512"><path d="M64 360a56 56 0 1 0 0 112 56 56 0 1 0 0-112zm0-160a56 56 0 1 0 0 112 56 56 0 1 0 0-112zM120 96A56 56 0 1 0 8 96a56 56 0 1 0 112 0z"/></svg>
      <div class="label clamp"></div>
      <svg class="expandToggle" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M32 32C14.3 32 0 46.3 0 64l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L32 32zM64 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 32c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM448 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96z"/></svg>
    </figcaption>
  
  </figure>

  <script type="module">

    import 'https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace/cdn/components/image-comparer/image-comparer.js';
    import { marked } from "https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";

    let iiifServiceUrl = 'https://iiif.mdpress.io';
    let imageServiceUrl = 'https://d1co2zgwaj21sl.cloudfront.net/image';

    const props = {
      ...{                   // default properties
        caption: null,
        position: 50,
        before: null,
        after: null,
        beforeManifest: null,
        afterManifest: null,
        beforeRegion: null,
        afterRegion: null,
        beforeAlt: 'Before image',
        afterAlt: 'After image'
      },
      ...Object.fromEntries( // URLSearchParams to object
        Array.from(new URLSearchParams(location.search).entries())
        .map(([key, value]) => [key, (value === 'true' || !value) ? true : value === 'false' ? false : value])
      )
    }
    console.log(props)

    const figure = document.querySelector('figure')
    const figcaption = document.querySelector('figcaption')
    const before = document.getElementById('before')
    const after = document.getElementById('after')
    
    const md2Html = (md) => marked.parse(md).slice(3, -5) // convert markdown to HTML
    const setCaption = (caption) => { figcaption.querySelector('.label').innerHTML = md2Html(caption) }
    if (props.caption) setCaption(props.caption)

    const expandToggle = figcaption.querySelector('.expandToggle')
    if (props['in-dialog']) expandToggle.style.display = 'none'
    else {
      expandToggle.addEventListener('click', e => {
        console.log('expand')
        window.parent.postMessage({ 
          type: 'showDialog', 
          props: {
            kwargs: {
              ...Object.fromEntries(Object.entries(props).filter(([_, value]) => value !== null && value !== false)),
              ...{
                tag: 'image-compare'
              }
            }
          }
        }, '*');
      })
    }

    // recursive helper for finding items in a IIIF manifest
    const findItems = (toMatch, current, found) => {
      found = found || []
      if (current?.items) {
        for (let i = 0; i < current.items.length; i++ ) {
          let item = current.items[i]
          let isMatch = !Object.entries(toMatch).find(([attr, val]) => item[attr] && item[attr] !== val)
          if (isMatch) found.push(item)
          else findItems(toMatch, item, found)
        }
      }
      return found
    }

    // find an item in a IIIF manifest
    const findItem = (toMatch, current, seq) => {
      seq = seq || 1
      const found = findItems(toMatch, current)
      return found.length >= seq ? found[seq-1] : null
    }

    const staticImageUrl = (manifest, width, crop) => {
      let itemInfo = manifest && findItem({type:'Annotation', motivation:'painting'}, manifest, props.seq).body
      if (!itemInfo) return ''
      let url
      let [region, size, rotation, rest] = props.options?.split('/') || []
      let [quality, format] = rest?.split('.') || []
      region = crop || props.region || region || 'full'
      size = width
        ? width === 'max'
          ? 'max'
          : `${width},`
        : props.size
          ? props.size
          : `${main.clientWidth},`
      rotation = parseInt(props.rotation || rotation || 0)
      quality = props.quality || quality || 'default'
      format = props.format || format || 'jpg'
      url =`${itemInfo.service[0].id || itemInfo.service[0]['@id']}/${region}/${size}/${rotation}/${quality}.${format}`
      return url
    }

    const makeManifestUrl = (s) => {
      if (s.indexOf('http') === 0) {
        return `${iiifServiceUrl}/${encodeURIComponent(s)}/manifest.json`
      } else if (s.indexOf('wc:') === 0 || s.indexOf('wikimedia.org') > -1 || s.indexOf('wikipedia.org') > -1 && props.src.indexOf('/media/File:') > -1) {
        let mwFile = s.replace(/^wc:/,'').replace(/Special:FilePath\//, 'File:').split('File:').pop()
        return `${iiifServiceUrl}/wc:${mwFile}/manifest.json`
      } else if (s.indexOf('gh:') === 0) {
        return `${iiifServiceUrl}/${s}/manifest.json`
      } else {
        if (s[0] === '/') {
          let [owner, repo, branch, ...rest] = props.ghbase.split('/')
          return `${iiifServiceUrl}/gh:${owner}/${repo}/${branch}${s}/manifest.json`
        } else {
          return `${iiifServiceUrl}/gh:${props.ghbase}/${s}/manifest.json`
        }
      }
    }

    const loadManifest = (manifestUrl) => {
      if (manifestUrl.indexOf('http') < 0) manifestUrl = `${iiifServiceUrl}/${manifestUrl}/manifest.json`
      return fetch(manifestUrl).then(resp => resp.json())
      .then( async manifest => {
        const contexts = Array.isArray(manifest['@context']) ? manifest['@context'] : [manifest['@context']]
        const isV3Manifest = contexts.find(ctx => ctx.indexOf('shared-canvas.org') > 0 || parseFloat(ctx.split('/').slice(-2,-1).pop()) < 3) ? false : true
        return isV3Manifest 
          ? manifest 
          : await fetch(`${iiifServiceUrl}/prezi2to3/`, { method: 'POST', body: JSON.stringify(manifest) }).then(resp => resp.json())
      })
    }

    if (props.beforeManifest) {
      loadManifest(makeManifestUrl(props.beforeManifest)).then(manifest => {
        const imageUrl = `${imageServiceUrl}/${staticImageUrl(manifest, main.clientWidth)}`
        before.src = imageUrl
        before.alt = props.beforeAlt || (manifest?.label?.en || manifest?.label?.none || Object.values(manifest.label)).join(' ')
      })
    } else if (props.before) {
      before.src = props.before
      before.alt = props.beforeAlt
    }

    if (props.afterManifest) {
      loadManifest(makeManifestUrl(props.afterManifest)).then(manifest => {
        const imageUrl = `${imageServiceUrl}/${staticImageUrl(manifest, main.clientWidth)}`
        after.src = imageUrl
        after.alt = props.afterAlt || (manifest?.label?.en || manifest?.label?.none || Object.values(manifest.label)).join(' ')
      })
    } else if (props.after) {
      after.src = props.after
      after.alt = props.afterAlt
    }
    
  </script>
  
</body>
</html>